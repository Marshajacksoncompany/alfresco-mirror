<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE beans PUBLIC '-//SPRING//DTD BEAN//EN' 'http://www.springframework.org/dtd/spring-beans.dtd'>

<beans>

    <bean id="CMISLifecycleBean" class="org.alfresco.opencmis.CMISLifecycleBean">
        <property name="cmisServiceFactory"     ref="CMISServiceFactory" />
    </bean>

    <bean id="CMISServiceFactory" class="org.alfresco.opencmis.AlfrescoCmisServiceFactory">
        <property name="cmisConnector"          ref="CMISConnector" />
    </bean>

    <bean id="CMISConnector" class="org.alfresco.opencmis.CMISConnector">
        <property name="store"                  value="${spaces.store}" />
        <property name="rootPath"               value="/${spaces.company_home.childname}" />
        <property name="typesDefaultMaxItems"   value="500" />
        <property name="typesDefaultDepth"      value="-1" />
        <property name="objectsDefaultMaxItems" value="10000" />
        <property name="objectsDefaultDepth"    value="100" />
        <property name="renditionKindMapping">
            <map>
                <entry key="cmis:thumbnail">
                    <list>
                        <value>doclib</value>
                    </list>
                </entry>
                <entry key="alf:webpreview">
                    <list>
                        <value>webpreview</value>
                        <value>imgpreview</value>
                    </list>
                </entry>
            </map>
        </property>
    
        <property name="OpenCMISDictionaryService" ref="OpenCMISDictionaryService" />
        <property name="OpenCMISQueryService"   ref="OpenCMISQueryService" />     
            
        <property name="descriptorService"      ref="DescriptorService" />
        <property name="nodeService"            ref="NodeService" />
        <property name="fileFolderService"      ref="FileFolderService" />
        <property name="versionService"         ref="VersionService" />
        <property name="checkOutCheckInService" ref="CheckoutCheckinService" />
        <property name="contentService"         ref="ContentService" />
        <property name="renditionService"       ref="RenditionService" />
        <property name="tenantAdminService"     ref="tenantAdminService" />
        <property name="transactionService"     ref="transactionService"/>
        <property name="authenticationService"  ref="authenticationService" />
        <property name="permissionService"      ref="PermissionService" />
        <property name="permissionModelDao"     ref="permissionsModelDAO" />
        <property name="mimetypeService"        ref="MimetypeService" />
        <property name="auditService"           ref="auditService" />
        <property name="namespaceService"       ref="namespaceService" />
        <property name="searchService"          ref="SearchService" />
    </bean>

    <bean id="OpenCMISDictionaryService" class="org.alfresco.opencmis.dictionary.CMISStrictDictionaryService" >
        <property name="dictionaryService"      ref="dictionaryService" />
        <property name="dictionaryDAO"          ref="dictionaryDAO" />
        <property name="OpenCMISMapping"        ref="OpenCMISMapping" />
        <property name="tenantService"          ref="tenantService" />
        <property name="serviceRegistry"        ref="ServiceRegistry" />
    </bean>

    <bean id="OpenCMISMapping" class="org.alfresco.opencmis.mapping.CMISMapping" >
        <property name="serviceRegistry"        ref="ServiceRegistry" />
        <property name="cmisConnector"          ref="CMISConnector" />
    </bean>


    <bean id="OpenCMISQueryService" class="org.alfresco.opencmis.search.CMISQueryServiceImpl" >
        <property name="OpenCMISDictionaryService" ref="OpenCMISDictionaryService" />   
        <property name="queryEngine"            ref="adm.luceneQueryEngine" />
        <property name="nodeService"            ref="nodeService" />
        <property name="alfrescoDictionaryService" ref="dictionaryService" />
    </bean>
    
    
    <bean id="CMISChangeLogDataExtractor" class="org.alfresco.opencmis.CMISChangeLogDataExtractor">
        <property name="nodeService"            ref="NodeService" />    
        <property name="OpenCMISDictionaryService" ref="OpenCMISDictionaryService" />
        <property name="registry"               ref="auditModel.extractorRegistry" />        
    </bean>
    
    <bean id="lucene.sql.cmis.strict" class="org.alfresco.repo.search.impl.lucene.LuceneOpenCMISStrictSqlQueryLanguage" >
        <property name="cmisQueryService">
            <ref bean="OpenCMISQueryService" />
        </property>
        <property name="factories">
            <list>
                <ref bean="admLuceneIndexerAndSearcherFactory" />
                <ref bean="admLuceneUnIndexedIndexerAndSearcherFactory" />
                <ref bean="avmLuceneIndexerAndSearcherFactory" />
            </list>
        </property>
    </bean>

    <bean id="lucene.sql.alfresco" class="org.alfresco.repo.search.impl.lucene.LuceneOpenCMISAlfrescoSqlQueryLanguage">
        <property name="cmisQueryService">
            <ref bean="OpenCMISQueryService" />
        </property>
        <property name="factories">
            <list>
                <ref bean="admLuceneIndexerAndSearcherFactory" />
                <ref bean="admLuceneUnIndexedIndexerAndSearcherFactory" />
                <ref bean="avmLuceneIndexerAndSearcherFactory" />
            </list>
        </property>
    </bean>
	
    <bean id="adm.luceneQueryEngine" class="org.springframework.aop.framework.ProxyFactoryBean">
        <property name="proxyInterfaces">
            <value>org.alfresco.repo.search.impl.querymodel.QueryEngine</value>
        </property>
        <property name="target">
            <ref bean="adm.luceneQueryEngineImpl"/>
        </property>
        <property name="interceptorNames">
            <list>
                <idref bean="adm.luceneQueryEngineSecurity"/>
            </list>
        </property>
    </bean>
   
   <bean id="adm.luceneQueryEngineSecurity" class="net.sf.acegisecurity.intercept.method.aopalliance.MethodSecurityInterceptor">
        <property name="authenticationManager"><ref bean="authenticationManager"/></property>
        <property name="accessDecisionManager"><ref bean="accessDecisionManager"/></property>
        <property name="afterInvocationManager"><ref bean="afterInvocationManager"/></property>
        <property name="objectDefinitionSource">
            <value>
               org.alfresco.repo.search.impl.querymodel.QueryEngine.executeQuery=ACL_ALLOW,AFTER_ACL_NODE.sys:base.Read
               org.alfresco.repo.search.impl.querymodel.QueryEngine.getQueryModelFactory=ACL_ALLOW
            </value>
        </property>
    </bean>
</beans>